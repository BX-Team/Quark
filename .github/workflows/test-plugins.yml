name: Build Test Plugins

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build test plugins
        run: ./gradlew buildTestPlugin

      - name: Prepare Bukkit test plugin artifact
        if: always()
        run: |
          if [ -d "bukkit/build/test-plugin" ] && [ "$(ls -A bukkit/build/test-plugin/*.jar 2>/dev/null)" ]; then
            mkdir -p artifacts/bukkit
            cp bukkit/build/test-plugin/*.jar artifacts/bukkit/
            echo "Bukkit test plugin files prepared"
          else
            echo "No Bukkit test plugin JARs found"
          fi

      - name: Prepare BungeeCord test plugin artifact
        if: always()
        run: |
          if [ -d "bungee/build/test-plugin" ] && [ "$(ls -A bungee/build/test-plugin/*.jar 2>/dev/null)" ]; then
            mkdir -p artifacts/bungee
            cp bungee/build/test-plugin/*.jar artifacts/bungee/
            echo "BungeeCord test plugin files prepared"
          else
            echo "No BungeeCord test plugin JARs found"
          fi

      - name: Prepare Paper test plugin artifact
        if: always()
        run: |
          if [ -d "paper/build/test-plugin" ] && [ "$(ls -A paper/build/test-plugin/*.jar 2>/dev/null)" ]; then
            mkdir -p artifacts/paper
            cp paper/build/test-plugin/*.jar artifacts/paper/
            echo "Paper test plugin files prepared"
          else
            echo "No Paper test plugin JARs found"
          fi

      - name: Prepare Velocity test plugin artifact
        if: always()
        run: |
          if [ -d "velocity/build/test-plugin" ] && [ "$(ls -A velocity/build/test-plugin/*.jar 2>/dev/null)" ]; then
            mkdir -p artifacts/velocity
            cp velocity/build/test-plugin/*.jar artifacts/velocity/
            echo "Velocity test plugin files prepared"
          else
            echo "No Velocity test plugin JARs found"
          fi

      - name: Upload Bukkit test plugin
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: QuarkBukkitTestPlugin
          path: artifacts/bukkit/
          if-no-files-found: warn
          retention-days: 30

      - name: Upload BungeeCord test plugin
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: QuarkBungeeTestPlugin
          path: artifacts/bungee/
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Paper test plugin
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: QuarkPaperTestPlugin
          path: artifacts/paper/
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Velocity test plugin
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: QuarkVelocityTestPlugin
          path: artifacts/velocity/
          if-no-files-found: warn
          retention-days: 30
